unit FRMALTERAPRECOS;

interface

uses
  Winapi.Windows, Winapi.Messages, System.SysUtils, System.Variants, System.Classes, Vcl.Graphics,
  Vcl.Controls, Vcl.Forms, Vcl.Dialogs, Data.DB, Vcl.ComCtrls, Vcl.DBCtrls,
  Vcl.StdCtrls, Vcl.ExtCtrls, Vcl.Grids, Vcl.DBGrids, Vcl.Buttons, Vcl.Mask,
  RxToolEdit, RxCurrEdit,Math, MemDS, DBAccess, Uni;

type
  TFormalterapreco = class(TForm)
    MENUPRECOS: TPageControl;
    TabSheet10: TTabSheet;
   
    Label76: TLabel;
    Panel31: TPanel;
    Label77: TLabel;
    Panel35: TPanel;
    Label78: TLabel;
    Label79: TLabel;
    Label80: TLabel;
    CEPERCENTUALATACADO4: TCurrencyEdit;
    CEPERCENTUALATACADO3: TCurrencyEdit;
    CEPERCENTUALATACADO2: TCurrencyEdit;
    Panel47: TPanel;
    Label86: TLabel;
    Label87: TLabel;
    Label88: TLabel;
    CEPERCENTUALVAREJO4: TCurrencyEdit;
    CEPERCENTUALVAREJO3: TCurrencyEdit;
    CEPERCENTUALVAREJO2: TCurrencyEdit;
    Panel34: TPanel;
    Label85: TLabel;
    Label81: TLabel;
    CEPERCENTUALVAREJO1: TCurrencyEdit;
    CEPERCENTUALATACADO1: TCurrencyEdit;
    btnatualizaprecos: TBitBtn;
    Button1: TCheckBox;
    DBGRIDPRODUTOSBASE: TDBGrid;
    TabSheet6: TTabSheet;
    Labelproduto: TLabel;
    Label109: TLabel;
    Panel55: TPanel;
    Panel57: TPanel;
    Label95: TLabel;
    editcodfornecedor: TEdit;
    Panel58: TPanel;
    Label96: TLabel;
    editcodbarra: TEdit;
    Panel59: TPanel;
    Label97: TLabel;
    editcodinterno: TEdit;
    Panel61: TPanel;
    Label99: TLabel;
    editcodorigem: TEdit;
    RadioGroup1: TRadioGroup;
    Panel74: TPanel;
    Label101: TLabel;
    Editlocalizacao: TEdit;
    Panel76: TPanel;
    Label98: TLabel;
    Editfornecedor: TEdit;
    Panel77: TPanel;
    Label107: TLabel;
    editmarca: TEdit;
    Panel78: TPanel;
    Label108: TLabel;
    Editgrupo: TEdit;
    btnconsultaprodutos: TBitBtn;
    Panel64: TPanel;
    Panel66: TPanel;
    Label105: TLabel;
    Panel70: TPanel;
    Label115: TLabel;
    Label116: TLabel;
    Label117: TLabel;
    Label118: TLabel;
    Label123: TLabel;
    Label100: TLabel;
    editprecoatacado1: TCurrencyEdit;
    editprecoatacado2: TCurrencyEdit;
    editprecoatacado3: TCurrencyEdit;
    editprecoatacado4: TCurrencyEdit;
    editqtdembalagem: TEdit;
    Panel69: TPanel;
    Label124: TLabel;
    Label125: TLabel;
    Label126: TLabel;
    Label127: TLabel;
    Label128: TLabel;
    editmargematacado1: TCurrencyEdit;
    editmargematacado2: TCurrencyEdit;
    editmargematacado3: TCurrencyEdit;
    editmargematacado4: TCurrencyEdit;
    Panel68: TPanel;
    Label104: TLabel;
    Label110: TLabel;
    Label112: TLabel;
    Label113: TLabel;
    Label141: TLabel;
    Label94: TLabel;
    editprecounatacado1: TCurrencyEdit;
    editprecounatacado2: TCurrencyEdit;
    editprecounatacado3: TCurrencyEdit;
    editprecounatacado4: TCurrencyEdit;
    editqtdminatacado: TEdit;
    Panel67: TPanel;
    Label111: TLabel;
    Label114: TLabel;
    Label106: TLabel;
    Editprcustomedio: TCurrencyEdit;
    Editprcusto: TCurrencyEdit;
    Panel65: TPanel;
    Label135: TLabel;
    Panel71: TPanel;
    Label119: TLabel;
    Label120: TLabel;
    Label121: TLabel;
    Label122: TLabel;
    Label129: TLabel;
    editprecovarejo1: TCurrencyEdit;
    editprecovarejo2: TCurrencyEdit;
    editprecovarejo3: TCurrencyEdit;
    editprecovarejo4: TCurrencyEdit;
    Panel72: TPanel;
    Label130: TLabel;
    Label131: TLabel;
    Label132: TLabel;
    Label133: TLabel;
    Label134: TLabel;
    editmargemvarejo1: TCurrencyEdit;
    editmargemvarejo2: TCurrencyEdit;
    editmargemvarejo3: TCurrencyEdit;
    editmargemvarejo4: TCurrencyEdit;
    Panel73: TPanel;
    Label102: TLabel;
    DBTextestoquedeposito: TDBText;
    Label103: TLabel;
    DBTexestoqueloja: TDBText;
    Label136: TLabel;
    DBTextestoquetotal: TDBText;
    Label137: TLabel;
    DBTextestoquefiscal: TDBText;
    Label138: TLabel;
    DBTextestoqueminino: TDBText;
    Label143: TLabel;
    Panel56: TPanel;
    Panel75: TPanel;
    Label139: TLabel;
    Label146: TLabel;
    dtultvenda: TDateTimePicker;
    dtultcompra: TDateTimePicker;
    Panel60: TPanel;
    Label144: TLabel;
    Label145: TLabel;
    dtultalteracao: TDateTimePicker;
    dtdatacastro: TDateTimePicker;
    Panel63: TPanel;
    Label142: TLabel;
    Label149: TLabel;
    dtultalteracaopreco: TDateTimePicker;
    editdiasnaoalterapreco: TEdit;
    Panel30: TPanel;
    Label140: TLabel;
    Label147: TLabel;
    Editultalterar: TEdit;
    editusuariomudoupreco: TEdit;
    Panel48: TPanel;
    Btnconsultaaberto: TBitBtn;
    btnconsultamov: TBitBtn;
    qrycarregaprodutos: TUniQuery;
    qrycarregadetalhes: TUniQuery;
    Panel3: TPanel;
    Panel1: TPanel;
    Label1: TLabel;
    Label5: TLabel;
    Label7: TLabel;
    Label8: TLabel;
    cmbgruponaoconsulta: TComboBox;
    cmbfornecedornaoconsulta: TComboBox;
    cmbmarcanaoconsulta: TComboBox;
    Panel2: TPanel;
    Label2: TLabel;
    Label3: TLabel;
    Label4: TLabel;
    Label6: TLabel;
    cmbgrupo: TComboBox;
    cmbfornecedor: TComboBox;
    cmbmarca: TComboBox;
    btnconsultar: TBitBtn;
    EDITCONSULTA: TEdit;
    Label9: TLabel;
    LABELTOTAL: TLabel;
    procedure CEPERCENTUALATACADO1Change(Sender: TObject);

    procedure CarregarListaBaseProdutos;
    procedure btnconsultarClick(Sender: TObject);
    procedure AtualizarDiasSemAlteracao;





    procedure ConsultarMovimentoProdutoBase;
    procedure DefinirPercentuaisPadrao;
    procedure AplicarAjusteDePrecosEmMassa;
     procedure CarregarGrupos;
     procedure CarregarMarcas;
     procedure CarregarFornecedores;
    procedure FormShow(Sender: TObject);
    procedure btnconsultaprodutosClick(Sender: TObject);
    procedure BtnconsultaabertoClick(Sender: TObject);
    procedure btnconsultamovClick(Sender: TObject);
    procedure CarregarUltimoUsuarioAlteracao;
    procedure btnatualizaprecosClick(Sender: TObject);
    procedure Button1Click(Sender: TObject);
    procedure CarregarFornecedoresnegativos;
     procedure  CarregarMarcasnegativas;
     procedure  CarregarGruposnegativos;

    procedure ContarRegistrosGrid;
    procedure CarregarDetalhesPorCodInterno(const sCodInterno: string);
    procedure DBGRIDPRODUTOSBASECellClick(Column: TColumn);


  private
    { Private declarations }
  public
    { Public declarations }


       procedure Estoque_RegistrarMovimentoPreco(sCodInterno: string; iLkUsuario: Integer; iLkItem: Integer;
    fCustoAnt, fVendaAnt, fMargemVarejoAnt, fPrPrazoAnt, fPerPrazoAnt, fPrAtacadoVarejoAnt, fPerAtacadoVarejoAnt,
    fPrMinimoAnt, fPerMinimoAnt, fPrAtacado1Ant, fPerAtacado1Ant: Extended;
    fCustoNovo, fVendaNovo, fMargemVarejoNovo, fPrPrazoNovo, fPerPrazoNovo, fPrAtacadoVarejoNovo, fPerAtacadoVarejoNovo,
    fPrMinimoNovo, fPerMinimoNovo, fPrAtacado1Novo, fPerAtacado1Novo: Extended);


  end;

var
  Formalterapreco: TFormalterapreco;

implementation

{$R *.dfm}

uses CONEXAOBD, FRM_MENU, FRMCONTARESTOQUE, FRMMOVIMENTO, FRMPOSICAOESTOQUE,
  FRMSelectproduto, FRMSENHA, TELAESPERA;



procedure Tformalterapreco.CarregarFornecedores;
begin
  // Garante que a conexão do componente QRYFORNECEDOR está ativa
  if not datamodule1.qryfornecedor.Connection.Connected then
    datamodule1.qryfornecedor.Connection.Connected := True;

  // Limpa o ComboBox
  cmbfornecedor.Items.Clear;


  // Adiciona a opção "Todos" com o valor 0
  cmbfornecedor.Items.AddObject('Todos', TObject(0));


  // Define a consulta SQL do seu QRYFORNECEDOR
  // A propriedade 'Sql.Text' do seu QRYFORNECEDOR deve ser configurada da seguinte forma:
  // 'SELECT Controle, Empresa FROM tabfor ORDER BY Empresa'
  // Abre a query para carregar os dados
  datamodule1.qryfornecedor.Open;
  try
    // Popula o ComboBox com os dados
    while not datamodule1.qryfornecedor.Eof do
    begin
      // Adiciona o nome da empresa (texto visível) e guarda o controle (objeto)
       cmbfornecedor.Items.AddObject(datamodule1.qryfornecedor.FieldByName('Empresa').AsString, TObject(datamodule1.qryfornecedor.FieldByName('Controle').AsInteger));
      datamodule1.qryfornecedor.Next;

    end;
  finally
    // Fecha a query para liberar recursos
    datamodule1.qryfornecedor.Close;
  end;

  // Seleciona a primeira opção ("Todos") por padrão
  cmbfornecedor.ItemIndex := 0;

end;






procedure Tformalterapreco.CarregarFornecedoresnegativos;
begin
  // Garante que a conexão do componente QRYFORNECEDOR está ativa
  if not datamodule1.qryfornecedor.Connection.Connected then
    datamodule1.qryfornecedor.Connection.Connected := True;

  // Limpa o ComboBox
  cmbfornecedornaoconsulta.Items.Clear;


  // Adiciona a opção "Todos" com o valor 0
  cmbfornecedornaoconsulta.Items.AddObject('Todos', TObject(0));


  // Define a consulta SQL do seu QRYFORNECEDOR
  // A propriedade 'Sql.Text' do seu QRYFORNECEDOR deve ser configurada da seguinte forma:
  // 'SELECT Controle, Empresa FROM tabfor ORDER BY Empresa'
  // Abre a query para carregar os dados
  datamodule1.qryfornecedor.Open;
  try
    // Popula o ComboBox com os dados
    while not datamodule1.qryfornecedor.Eof do
    begin
      // Adiciona o nome da empresa (texto visível) e guarda o controle (objeto)
       cmbfornecedornaoconsulta.Items.AddObject(datamodule1.qryfornecedor.FieldByName('Empresa').AsString, TObject(datamodule1.qryfornecedor.FieldByName('Controle').AsInteger));
      datamodule1.qryfornecedor.Next;

    end;
  finally
    // Fecha a query para liberar recursos
    datamodule1.qryfornecedor.Close;
  end;

  // Seleciona a primeira opção ("Todos") por padrão
  cmbfornecedornaoconsulta.ItemIndex := 0;

end;




















  procedure Tformalterapreco.CarregarGrupos;
begin
  // Garante que a conexão do componente QRYGRUPOS está ativa
  if not datamodule1.qrygrupos.Connection.Connected then
    datamodule1.qrygrupos.Connection.Connected := True;

  // Limpa o ComboBox
  cmbgrupo.Items.Clear;


  // Adiciona a opção "Todos" com o valor 0
  cmbgrupo.Items.AddObject('Todos', TObject(0));


  // Abre a query para carregar os dados
  datamodule1.qrygrupos.Open;
  try
    // Popula o ComboBox com os dados
    while not datamodule1.qrygrupos.Eof do
    begin
      // Adiciona o nome do setor (texto visível) e guarda o controle (objeto)
      cmbgrupo.Items.AddObject(datamodule1.qrygrupos.FieldByName('Setor').AsString, TObject(datamodule1.qrygrupos.FieldByName('Controle').AsInteger));
      datamodule1.qrygrupos.Next;

    end;
  finally
    // Fecha a query para liberar recursos
    datamodule1.qrygrupos.Close;
  end;

  // Seleciona a primeira opção ("Todos") por padrão
  cmbgrupo.ItemIndex := 0;

end;







 procedure Tformalterapreco.CarregarGruposnegativos;
begin
  // Garante que a conexão do componente QRYGRUPOS está ativa
  if not datamodule1.qrygrupos.Connection.Connected then
    datamodule1.qrygrupos.Connection.Connected := True;

  // Limpa o ComboBox
  cmbgruponaoconsulta.Items.Clear;


  // Adiciona a opção "Todos" com o valor 0
 cmbgruponaoconsulta.Items.AddObject('Todos', TObject(0));


  // Abre a query para carregar os dados
  datamodule1.qrygrupos.Open;
  try
    // Popula o ComboBox com os dados
    while not datamodule1.qrygrupos.Eof do
    begin
      // Adiciona o nome do setor (texto visível) e guarda o controle (objeto)
      cmbgruponaoconsulta.Items.AddObject(datamodule1.qrygrupos.FieldByName('Setor').AsString, TObject(datamodule1.qrygrupos.FieldByName('Controle').AsInteger));
      datamodule1.qrygrupos.Next;

    end;
  finally
    // Fecha a query para liberar recursos
    datamodule1.qrygrupos.Close;
  end;

  // Seleciona a primeira opção ("Todos") por padrão
  cmbgruponaoconsulta.ItemIndex := 0;

end;












procedure Tformalterapreco.CarregarMarcas;
var
  Marca: string;
begin
  // Garante que a conexão do componente QRYMARCA está ativa
  if not datamodule1.qrymarca.Connection.Connected then
    datamodule1.qrymarca.Connection.Connected := True;

  // Limpa o ComboBox
  cmbmarca.Items.Clear;

  // Adiciona a opção "Todos"
  cmbmarca.Items.AddObject('Todos', TObject(0));

  // Define a consulta SQL para buscar fabricantes únicos e não nulos
  // A propriedade 'Sql.Text' do seu QRYMARCA deve ser configurada da seguinte forma:
  // 'SELECT DISTINCT FABRICANTE FROM tabest1 WHERE FABRICANTE IS NOT NULL AND FABRICANTE <> '' ORDER BY FABRICANTE'
  // Abre a query para carregar os dados
  datamodule1.qrymarca.Open;
  try
    // Popula o ComboBox com os dados
    while not datamodule1.qrymarca.Eof do
    begin
      Marca := datamodule1.qrymarca.FieldByName('FABRICANTE').AsString;
      // Adiciona a marca (texto visível) e guarda a mesma string como objeto
      cmbmarca.Items.AddObject(Marca, TObject(Marca));
      datamodule1.qrymarca.Next;
    end;
  finally
    // Fecha a query para liberar recursos
    datamodule1.qrymarca.Close;
  end;

  // Seleciona a primeira opção ("Todos") por padrão
  cmbmarca.ItemIndex := 0;
end;







procedure Tformalterapreco.CarregarMarcasnegativas;
var
  Marca: string;
begin
  // Garante que a conexão do componente QRYMARCA está ativa
  if not datamodule1.qrymarca.Connection.Connected then
    datamodule1.qrymarca.Connection.Connected := True;

  // Limpa o ComboBox
  cmbmarcanaoconsulta.Items.Clear;

  // Adiciona a opção "Todos"
   cmbmarcanaoconsulta.Items.AddObject('Todos', TObject(0));

  // Define a consulta SQL para buscar fabricantes únicos e não nulos
  // A propriedade 'Sql.Text' do seu QRYMARCA deve ser configurada da seguinte forma:
  // 'SELECT DISTINCT FABRICANTE FROM tabest1 WHERE FABRICANTE IS NOT NULL AND FABRICANTE <> '' ORDER BY FABRICANTE'
  // Abre a query para carregar os dados
  datamodule1.qrymarca.Open;
  try
    // Popula o ComboBox com os dados
    while not datamodule1.qrymarca.Eof do
    begin
      Marca := datamodule1.qrymarca.FieldByName('FABRICANTE').AsString;
      // Adiciona a marca (texto visível) e guarda a mesma string como objeto
       cmbmarcanaoconsulta.Items.AddObject(Marca, TObject(Marca));
      datamodule1.qrymarca.Next;
    end;
  finally
    // Fecha a query para liberar recursos
    datamodule1.qrymarca.Close;
  end;

  // Seleciona a primeira opção ("Todos") por padrão
   cmbmarcanaoconsulta.ItemIndex := 0;
end;















procedure TFormalterapreco.CEPERCENTUALATACADO1Change(Sender: TObject);
var
  fNovoPercentual: Extended;
begin
  // 1. Coleta o novo valor do campo 1 (CEPERCENTUALATACADO1)
  // O valor é lido diretamente do TCurrencyEdit.
  fNovoPercentual := TCurrencyEdit(Sender).Value;

  // 2. Propaga o valor para os demais campos de Atacado (2, 3 e 4)
  if Assigned(CEPERCENTUALATACADO2) then
    CEPERCENTUALATACADO2.Value := fNovoPercentual;

  if Assigned(CEPERCENTUALATACADO3) then
    CEPERCENTUALATACADO3.Value := fNovoPercentual;

  if Assigned(CEPERCENTUALATACADO4) then
    CEPERCENTUALATACADO4.Value := fNovoPercentual;

  // Nota: Não é necessário chamar a rotina de ajuste em massa aqui.
  // A rotina AplicarAjusteDePrecosEmMassa lerá esses valores já ajustados quando for executada.
end;








procedure TFormalterapreco.BtnconsultaabertoClick(Sender: TObject);
begin
 if not Assigned(Formposicaoest) then
    Formposicaoest := TFormposicaoest.Create(Application);
Formposicaoest.CarregarPosicaodecodinternocadastro;
 Formposicaoest.ShowModal;




end;

procedure TFormalterapreco.btnconsultamovClick(Sender: TObject);
begin

if not Assigned(formmov) then
    formmov := Tformmov.Create(Application);
formmov.CarregaMovalterapreco;


end;

procedure TFormalterapreco.btnconsultaprodutosClick(Sender: TObject);
begin
  // 1. Cria ou exibe a instância do novo formulário
  if not Assigned(Formposicaoest) then
    selectproduto := Tselectproduto.Create(Application);

  // 2. Chama a procedure para carregar a posição, passando as datas como parâmetro


  // 3. Exibe o formulário
  selectproduto.ShowModal;
end;

procedure TFormalterapreco.btnconsultarClick(Sender: TObject);
begin
CarregarListaBaseProdutos;
ContarRegistrosGrid;
end;

procedure TFormalterapreco.Button1Click(Sender: TObject);
begin
DefinirPercentuaisPadrao;
end;





procedure tformalterapreco.Estoque_RegistrarMovimentoPreco(sCodInterno: string; iLkUsuario: Integer; iLkItem: Integer;
    fCustoAnt, fVendaAnt, fMargemVarejoAnt, fPrPrazoAnt, fPerPrazoAnt, fPrAtacadoVarejoAnt, fPerAtacadoVarejoAnt,
    fPrMinimoAnt, fPerMinimoAnt, fPrAtacado1Ant, fPerAtacado1Ant: Extended;
    fCustoNovo, fVendaNovo, fMargemVarejoNovo, fPrPrazoNovo, fPerPrazoNovo, fPrAtacadoVarejoNovo, fPerAtacadoVarejoNovo,
    fPrMinimoNovo, fPerMinimoNovo, fPrAtacado1Novo, fPerAtacado1Novo: Extended);
const
  LK_TIPO_ALTERACAO_PRECO = 7;
  LK_OPERACAO_INTERNA = 1;
var
  sTerminal: string;
  iTamanhoTerminal: DWord;
begin
  // 1. OBTENÇÃO DO NOME DO COMPUTADOR (TERMINAL)
  sTerminal := '';
  iTamanhoTerminal := MAX_COMPUTERNAME_LENGTH + 1;
  SetLength(sTerminal, iTamanhoTerminal);

  if Winapi.Windows.GetComputerName(PChar(sTerminal), iTamanhoTerminal) then
    SetLength(sTerminal, iTamanhoTerminal);

  sTerminal := Trim(sTerminal);

  // 2. EXECUÇÃO DO INSERT na TABEST1MOV com TODOS os campos de PREÇO
  with DataModule1.QRYUPDATETABESTMOV do
  begin
    Close;
    SQL.Text :=
      'INSERT INTO TabEst1Mov ' +
      ' (Data, CodInterno, Quantidade, SaldoAnterior, Saldo, LkOperacao, LkUsuario, LkItem, LkTipo, Terminal, ' +
      // CAMPOS ANTERIORES
      ' PrecoCustoAnterior, PrecoVendaAnterior, MargemVarejoAnterior, PrPrazoAnterior, PerPrazoAnterior, ' +
      ' PrAtacadoVarejoAnterior, PerAtacadoVarejoAnterior, PrMinimoAnterior, PerMinimoAnterior, PrAtacado1Anterior, PerAtacado1Anterior, ' +
      // CAMPOS NOVOS
      ' PrecoCustoNovo, PrecoVendaNovo, MargemVarejoNova, PrPrazoNovo, PerPrazoNovo, ' +
      ' PrAtacadoVarejoNovo, PerAtacadoVarejoNovo, PrMinimoNovo, PerMinimoNovo, PrAtacado1Novo, PerAtacado1Novo) ' +
      'VALUES (GETDATE(), :CodInt, :QtdMov, :SaldoAnt, :SaldoAtual, :LkOp, :LkUser, :LkItem, :LkTipo, :Terminal, ' +
      // VALORES ANTERIORES
      ' :CustoAnt, :VendaAnt, :MargemAnt, :PrPrazoAnt, :PerPrazoAnt, :PrAtacadoVarejoAnt, :PerAtacadoVarejoAnt, :PrMinimoAnt, :PerMinimoAnt, :PrAtacado1Ant, :PerAtacado1Ant, ' +
      // VALORES NOVOS
      ' :CustoNovo, :VendaNovo, :MargemNovo, :PrPrazoNovo, :PerPrazoNovo, :PrAtacadoVarejoNovo, :PerAtacadoVarejoNovo, :PrMinimoNovo, :PerMinimoNovo, :PrAtacado1Novo, :PerAtacado1Novo)';

    // Parâmetros de Estoque (Zerados)
    ParamByName('CodInt').AsString := sCodInterno;
    ParamByName('QtdMov').AsFloat := 0.0;
    ParamByName('SaldoAnt').AsFloat := 0.0;
    ParamByName('SaldoAtual').AsFloat := 0.0;

    ParamByName('LkOp').AsInteger := LK_OPERACAO_INTERNA;
    ParamByName('LkUser').AsInteger := iLkUsuario;
    ParamByName('LkItem').AsInteger := iLkItem;
    ParamByName('LkTipo').AsInteger := LK_TIPO_ALTERACAO_PRECO;
    ParamByName('Terminal').AsString := sTerminal;

    // 3. ATRIBUIÇÃO DOS VALORES ANTERIORES (Extended/Float -> Currency/Float)
    ParamByName('CustoAnt').AsCurrency := fCustoAnt;
    ParamByName('VendaAnt').AsCurrency := fVendaAnt;
    ParamByName('MargemAnt').AsFloat := fMargemVarejoAnt;
    ParamByName('PrPrazoAnt').AsCurrency := fPrPrazoAnt;
    ParamByName('PerPrazoAnt').AsFloat := fPerPrazoAnt;
    ParamByName('PrAtacadoVarejoAnt').AsCurrency := fPrAtacadoVarejoAnt;
    ParamByName('PerAtacadoVarejoAnt').AsFloat := fPerAtacadoVarejoAnt;
    ParamByName('PrMinimoAnt').AsCurrency := fPrMinimoAnt;
    ParamByName('PerMinimoAnt').AsFloat := fPerMinimoAnt;
    ParamByName('PrAtacado1Ant').AsCurrency := fPrAtacado1Ant;
    ParamByName('PerAtacado1Ant').AsFloat := fPerAtacado1Ant;

    // 4. ATRIBUIÇÃO DOS VALORES NOVOS (Extended/Float -> Currency/Float)
    ParamByName('CustoNovo').AsCurrency := fCustoNovo;
    ParamByName('VendaNovo').AsCurrency := fVendaNovo;
    ParamByName('MargemNovo').AsFloat := fMargemVarejoNovo;
    ParamByName('PrPrazoNovo').AsCurrency := fPrPrazoNovo;
    ParamByName('PerPrazoNovo').AsFloat := fPerPrazoNovo;
    ParamByName('PrAtacadoVarejoNovo').AsCurrency := fPrAtacadoVarejoNovo;
    ParamByName('PerAtacadoVarejoNovo').AsFloat := fPerAtacadoVarejoNovo;
    ParamByName('PrMinimoNovo').AsCurrency := fPrMinimoNovo;
    ParamByName('PerMinimoNovo').AsFloat := fPerMinimoNovo;
    ParamByName('PrAtacado1Novo').AsCurrency := fPrAtacado1Novo;
    ParamByName('PerAtacado1Novo').AsFloat := fPerAtacado1Novo;

    Execute;
  end;
end;


procedure Tformalterapreco.ConsultarMovimentoProdutoBase;
var
  sCodInterno: string;
begin
  // 1. Validação e Captura do CodInterno do Edit
  if not Assigned(Editcodinterno) or (Trim(Editcodinterno.Text) = '') then
  begin
    ShowMessage('O campo "Código Interno" (Editcodinterno) está vazio. Por favor, carregue um produto.');
    Exit;
  end;

  sCodInterno := Trim(Editcodinterno.Text);

  try
    // 2. Define e executa o SQL para consultar a TabEst1Mov
    with DataModule1.qryTabest1mov do
    begin
      Close;

      SQL.Clear;
      SQL.Add('SELECT top 50');

      // M.*: Seleciona todos os campos da TabEst1Mov (incluindo todos os campos de preço/margem)
      // T.*: Seleciona todos os campos da TabEstMovTipo (incluindo Tipo e LkOperacao)
      // U.USUARIO: Seleciona o nome do usuário
      SQL.Add('    M.*, T.*, U.USUARIO AS NomeUsuario');

      SQL.Add('FROM');
      SQL.Add('TabEst1Mov M WITH (NOLOCK)');
      SQL.Add('INNER JOIN SERV U ON U.Controle = M.LkUsuario');
      SQL.Add('INNER JOIN TabEstMovTipo T ON T.Controle = M.LkTipo');

      // Filtro pelo CodInterno do produto selecionado
      SQL.Add('WHERE M.CodInterno = :CodInterno');
      SQL.Add('ORDER BY M.Data DESC');

      // Define o parâmetro antes de abrir
      ParamByName('CodInterno').AsString := sCodInterno;

      // 3. Abre a Query
      Open;
    end;



  except
    on E: Exception do
    begin
      ShowMessage('Erro ao consultar movimentação do produto: ' + E.Message);
    end;
  end;
end;










procedure TFormalterapreco.DBGRIDPRODUTOSBASECellClick(Column: TColumn);
var
  sCodInterno: string;
begin
  // 1. Verifica se a Query está aberta e não está vazia.
  if (DataModule1.QRYPRODUTOSBASE.Active) and (not DataModule1.QRYPRODUTOSBASE.IsEmpty) then
  begin
    // 2. Captura o CodInterno do registro atualmente selecionado no DataModule.
    // O DBGrid garante que o cursor está posicionado no clique.
    sCodInterno := DataModule1.QRYPRODUTOSBASE.FieldByName('CODINTERNO').AsString;

    // 3. Chama a procedure que carrega todos os detalhes com base no CodInterno.
    CarregarDetalhesPorCodInterno(sCodInterno);
  end;
end;



procedure Tformalterapreco.DefinirPercentuaisPadrao;
begin
  // =========================================================
  // MARGENS DE VAREJO
  // As margens de 2 a 4 são descontos, por isso usamos valores negativos.
  // =========================================================
  if Assigned(CEPERCENTUALVAREJO1) then
    CEPERCENTUALVAREJO1.Value := 10.00; // 10% (Margem de lucro base)

  if Assigned(CEPERCENTUALVAREJO2) then
    CEPERCENTUALVAREJO2.Value := -3.00; // -3% (Desconto/Nível 2)

  if Assigned(CEPERCENTUALVAREJO3) then
    CEPERCENTUALVAREJO3.Value := -6.00; // -6% (Desconto/Nível 3)

  if Assigned(CEPERCENTUALVAREJO4) then
    CEPERCENTUALVAREJO4.Value := -9.00; // -9% (Desconto/Nível 4)


  // =========================================================
  // MARGENS DE ATACADO
  // Todos os níveis de atacado têm 10% (Margem de lucro)
  // =========================================================
  if Assigned(CEPERCENTUALATACADO1) then
    CEPERCENTUALATACADO1.Value := 10.00;

  if Assigned(CEPERCENTUALATACADO2) then
    CEPERCENTUALATACADO2.Value := 10.00;

  if Assigned(CEPERCENTUALATACADO3) then
    CEPERCENTUALATACADO3.Value := 10.00;

  if Assigned(CEPERCENTUALATACADO4) then
    CEPERCENTUALATACADO4.Value := 10.00;
end;




procedure TFormalterapreco.FormShow(Sender: TObject);
begin
    CarregarGrupos;
    CarregarMarcas;
    CarregarFornecedores;
    DefinirPercentuaisPadrao;
    CarregarFornecedoresnegativos;
    CarregarGruposnegativos;
    CarregarMarcasnegativas;
end;






procedure Tformalterapreco.AplicarAjusteDePrecosEmMassa;
const
  PERC_BASE = 100.00;
  // Descontos fixos Varejo (mantidos)
  DESCONTO_VAREJO_2 = -3.00;
  DESCONTO_VAREJO_3 = -6.00;
  DESCONTO_VAREJO_4 = -9.00;
var
  iContador: Integer;
  iLkUsuario: Integer;
  fPrecoCusto: Extended;

  // Variáveis Varejo
  fVendaAnterior, fPrecoVarejoBase, fPrecoVendaNovo, fMargemVarejoNova, fNovoPrecoVarejo: Extended;

  // Variáveis Atacado
  fPrAtacado1UnAnt: Extended;      // O valor que está no banco hoje
  fPerReajusteAtacado: Extended;   // O percentual que você digitou (Ex: 20%)
  fNovoPrecoAtacadoUnico: Extended; // O resultado final (Ex: 12,00)
  fMargemAtacadoReal: Extended;    // A margem recalculada para gravar no cadastro

  // Inputs
  fPerVarejo1: Extended;

  // Auxiliares Log (Valores Antigos)
  fCustoAnterior, fMargemVarejoAnterior, fPrPrazoAnterior, fPerPrazoAnt: Extended;
  fPrAtacadoVarejoAnterior, fPerAtacadoVarejoAnt, fPrMinimoAnterior, fPerMinimoAnt: Extended;
  fPrAtacado1Anterior, fPerAtacado1Ant: Extended;

  // Auxiliares Log (Valores Novos)
  fPrPrazoNovo, fPerPrazoNovo, fPrAtacadoVarejoNovo, fPerAtacadoVarejoNovo: Extended;
  fPrMinimoNovo, fPerMinimoNovo, fPrAtacado1Novo, fPerAtacado1Novo: Extended;

  FrmEsperaLocal: TFRMESPERA;

begin
  // 1. Validação
  if datamodule1.QRYPRODUTOSBASE.IsEmpty then
  begin
    ShowMessage('A lista de produtos para ajuste está vazia.');
    Exit;
  end;

  if MessageDlg('Confirma o reajuste? (Varejo sobre Venda Atual / Atacado Unitário sobre Unitário Atual)',
    mtConfirmation, [mbYes, mbNo], 0) = mrNo then
    Exit;

  // 2. CORREÇÃO DO SQL UPDATE (Garante que os campos existem)
  DataModule1.QRYALTERAPRECOS.Close;
  DataModule1.QRYALTERAPRECOS.SQL.Clear;
  DataModule1.QRYALTERAPRECOS.SQL.Add('UPDATE TabEst1 SET');
  // Varejo
  DataModule1.QRYALTERAPRECOS.SQL.Add('  PrecoVenda = :PrVarejo1, Lucro = :PerVarejo1,');
  DataModule1.QRYALTERAPRECOS.SQL.Add('  PrPrazo = :PrVarejo2, PerPrazo = :PerVarejo2,');
  DataModule1.QRYALTERAPRECOS.SQL.Add('  PrAtacado = :PrVarejo3, PerAtacado = :PerVarejo3,');
  DataModule1.QRYALTERAPRECOS.SQL.Add('  PrMinimo = :PrVarejo4, PerMinimo = :PerVarejo4,');
  // Atacado CAIXA (Mantém margem recalculada)
  DataModule1.QRYALTERAPRECOS.SQL.Add('  PerAtacado1 = :PerAtacado1,');
  DataModule1.QRYALTERAPRECOS.SQL.Add('  PerAtacado2 = :PerAtacado2,');
  DataModule1.QRYALTERAPRECOS.SQL.Add('  PerAtacado3 = :PerAtacado3,');
  DataModule1.QRYALTERAPRECOS.SQL.Add('  PerAtacado4 = :PerAtacado4,');
  // Atacado UNITÁRIO (Os campos que queremos editar)
  DataModule1.QRYALTERAPRECOS.SQL.Add('  PrAtacado1Un = :PrAtacado1Un,');
  DataModule1.QRYALTERAPRECOS.SQL.Add('  PrAtacado2Un = :PrAtacado2Un,');
  DataModule1.QRYALTERAPRECOS.SQL.Add('  PrAtacado3Un = :PrAtacado3Un,');
  DataModule1.QRYALTERAPRECOS.SQL.Add('  PrAtacado4Un = :PrAtacado4Un,');
  // Auditoria
  DataModule1.QRYALTERAPRECOS.SQL.Add('  LkUsuario = :LkUsuario, DtAlteracao = GETDATE()');
  DataModule1.QRYALTERAPRECOS.SQL.Add('WHERE Controle = :Controle');

  // 3. Captura dos Inputs
  fPerVarejo1  := CEPERCENTUALVAREJO1.Value;

  // IMPORTANTE: Aqui pegamos o valor digitado (Ex: 20)
  fPerReajusteAtacado := CEPERCENTUALATACADO1.Value;

  if Assigned(FRMSEN) then iLkUsuario := FRMSEN.UsuarioControle else iLkUsuario := 0;

  DataModule1.ConDados.StartTransaction;
  datamodule1.QRYPRODUTOSBASE.DisableControls;
  iContador := 0;

  FrmEsperaLocal := TFRMESPERA.Create(Application);
  FrmEsperaLocal.Label1.Caption := 'Aplicando reajustes...';
  FrmEsperaLocal.Show;
  Application.ProcessMessages;

  try
    datamodule1.QRYPRODUTOSBASE.First;
    while not datamodule1.QRYPRODUTOSBASE.Eof do
    begin
      // Leitura Banco
      fPrecoCusto    := datamodule1.QRYPRODUTOSBASE.FieldByName('PrecoCusto').AsFloat;
      fVendaAnterior := datamodule1.QRYPRODUTOSBASE.FieldByName('PrecoVarejo').AsFloat;

      // LEITURA DO UNITÁRIO 1 ATUAL (Sua Base de Cálculo)
      fPrAtacado1UnAnt := datamodule1.QRYPRODUTOSBASE.FieldByName('PrAtacado1Un').AsFloat;

      // VARIAVEIS DE LOG (Valores Antigos)
      fCustoAnterior := fPrecoCusto;
      fMargemVarejoAnterior := datamodule1.QRYPRODUTOSBASE.FieldByName('MargemVarejo').AsFloat;
      fPrPrazoAnterior := datamodule1.QRYPRODUTOSBASE.FieldByName('PrPrazo').AsFloat;
      fPerPrazoAnt := datamodule1.QRYPRODUTOSBASE.FieldByName('PerPrazo').AsFloat;
      fPrAtacadoVarejoAnterior := datamodule1.QRYPRODUTOSBASE.FieldByName('PrAtacado').AsFloat;
      fPerAtacadoVarejoAnt := datamodule1.QRYPRODUTOSBASE.FieldByName('PerAtacado').AsFloat;
      fPrMinimoAnterior := datamodule1.QRYPRODUTOSBASE.FieldByName('PrMinimo').AsFloat;
      fPerMinimoAnt := datamodule1.QRYPRODUTOSBASE.FieldByName('PerMinimo').AsFloat;
      fPrAtacado1Anterior := datamodule1.QRYPRODUTOSBASE.FieldByName('PrAtacado1').AsFloat;
      fPerAtacado1Ant := datamodule1.QRYPRODUTOSBASE.FieldByName('PerAtacado1').AsFloat;

      // -----------------------------------------------------------------------
      // CÁLCULO VAREJO
      // -----------------------------------------------------------------------
      fPrecoVarejoBase := RoundTo(fVendaAnterior * (1 + (fPerVarejo1 / PERC_BASE)), -2);
      fPrecoVendaNovo := fPrecoVarejoBase;

      if fPrecoCusto > 0 then
         fMargemVarejoNova := ((fPrecoVendaNovo - fPrecoCusto) / fPrecoCusto) * 100
      else
         fMargemVarejoNova := 100;

      DataModule1.QRYALTERAPRECOS.ParamByName('PrVarejo1').AsFloat := fPrecoVendaNovo;
      DataModule1.QRYALTERAPRECOS.ParamByName('PerVarejo1').AsFloat := fMargemVarejoNova;

      // Varejo Secundários
      fNovoPrecoVarejo := RoundTo(fPrecoVarejoBase * (1 + (DESCONTO_VAREJO_2 / PERC_BASE)), -2);
      DataModule1.QRYALTERAPRECOS.ParamByName('PrVarejo2').AsFloat := fNovoPrecoVarejo;
      DataModule1.QRYALTERAPRECOS.ParamByName('PerVarejo2').AsFloat := DESCONTO_VAREJO_2;

      fNovoPrecoVarejo := RoundTo(fPrecoVarejoBase * (1 + (DESCONTO_VAREJO_3 / PERC_BASE)), -2);
      DataModule1.QRYALTERAPRECOS.ParamByName('PrVarejo3').AsFloat := fNovoPrecoVarejo;
      DataModule1.QRYALTERAPRECOS.ParamByName('PerVarejo3').AsFloat := DESCONTO_VAREJO_3;

      fNovoPrecoVarejo := RoundTo(fPrecoVarejoBase * (1 + (DESCONTO_VAREJO_4 / PERC_BASE)), -2);
      DataModule1.QRYALTERAPRECOS.ParamByName('PrVarejo4').AsFloat := fNovoPrecoVarejo;
      DataModule1.QRYALTERAPRECOS.ParamByName('PerVarejo4').AsFloat := DESCONTO_VAREJO_4;

      // -----------------------------------------------------------------------
      // CÁLCULO ATACADO UNITÁRIO (CORRIGIDO AQUI)
      // -----------------------------------------------------------------------

      // 1. Pega o Preço Antigo (Ex: 10,00)
      // 2. Aplica o percentual digitado (Ex: 20%) -> 10 * 1.20 = 12,00
      fNovoPrecoAtacadoUnico := RoundTo(fPrAtacado1UnAnt * (1 + (fPerReajusteAtacado / PERC_BASE)), -2);

      // 3. Aplica esse preço NOVO nos 4 campos
      DataModule1.QRYALTERAPRECOS.ParamByName('PrAtacado1Un').AsFloat := fNovoPrecoAtacadoUnico;
      DataModule1.QRYALTERAPRECOS.ParamByName('PrAtacado2Un').AsFloat := fNovoPrecoAtacadoUnico;
      DataModule1.QRYALTERAPRECOS.ParamByName('PrAtacado3Un').AsFloat := fNovoPrecoAtacadoUnico;
      DataModule1.QRYALTERAPRECOS.ParamByName('PrAtacado4Un').AsFloat := fNovoPrecoAtacadoUnico;

      // 4. Atualiza o cadastro da MARGEM DO ATACADO para ficar coerente com o custo
      // (Isso evita que fique o valor "100" errado, ele calcula a margem real do novo preço)
      if fPrecoCusto > 0 then
         fMargemAtacadoReal := ((fNovoPrecoAtacadoUnico - fPrecoCusto) / fPrecoCusto) * 100
      else
         fMargemAtacadoReal := 100;

      DataModule1.QRYALTERAPRECOS.ParamByName('PerAtacado1').AsFloat := fMargemAtacadoReal;
      DataModule1.QRYALTERAPRECOS.ParamByName('PerAtacado2').AsFloat := fMargemAtacadoReal;
      DataModule1.QRYALTERAPRECOS.ParamByName('PerAtacado3').AsFloat := fMargemAtacadoReal;
      DataModule1.QRYALTERAPRECOS.ParamByName('PerAtacado4').AsFloat := fMargemAtacadoReal;

      // Var Log Atacado
      fPrAtacado1Novo := fNovoPrecoAtacadoUnico;
      fPerAtacado1Novo := fMargemAtacadoReal;

      // Executa
      DataModule1.QRYALTERAPRECOS.ParamByName('Controle').AsInteger := datamodule1.QRYPRODUTOSBASE.FieldByName('LkProduto').AsInteger;
      DataModule1.QRYALTERAPRECOS.ParamByName('LkUsuario').AsInteger := iLkUsuario;
      DataModule1.QRYALTERAPRECOS.Execute;

      // Log
      Estoque_RegistrarMovimentoPreco(
          datamodule1.QRYPRODUTOSBASE.FieldByName('CodInterno').AsString,
          iLkUsuario,
          datamodule1.QRYPRODUTOSBASE.FieldByName('LkProduto').AsInteger,
          // Antigos
          fCustoAnterior, fVendaAnterior, fMargemVarejoAnterior, fPrPrazoAnterior, fPerPrazoAnt,
          fPrAtacadoVarejoAnterior, fPerAtacadoVarejoAnt, fPrMinimoAnterior, fPerMinimoAnt,
          fPrAtacado1Anterior, fPerAtacado1Ant,
          // Novos
          fPrecoCusto, fPrecoVendaNovo, fMargemVarejoNova, fPrPrazoNovo, fPerPrazoNovo,
          fPrAtacadoVarejoNovo, fPerAtacadoVarejoNovo, fPrMinimoNovo, fPerMinimoNovo,
          fPrAtacado1Novo, fPerAtacado1Novo
      );

      Inc(iContador);
      datamodule1.QRYPRODUTOSBASE.Next;

      if (iContador mod 50 = 0) then begin
        FrmEsperaLocal.Label1.Caption := Format('Atualizando... %d produtos.', [iContador]);
        Application.ProcessMessages;
      end;
    end;

    DataModule1.ConDados.Commit;
    ShowMessage(Format('Sucesso! %d produtos atualizados.', [iContador]));

  except
    on E: Exception do
    begin
      DataModule1.ConDados.Rollback;
      ShowMessage('ERRO: ' + E.Message);
    end;
  end;

  datamodule1.QRYPRODUTOSBASE.EnableControls;
  datamodule1.QRYPRODUTOSBASE.Refresh;
  FrmEsperaLocal.Free;
end;




procedure TFormalterapreco.AtualizarDiasSemAlteracao;
var
  DataUltimaAlteracao: TDateTime;
  DataAtual: TDateTime;
  DiasDiferenca: Extended; // Usar Extended para precisão no cálculo
begin
  // 1. Coleta a Data da Última Alteração de Preço
  // Checagem de segurança se o componente existe e se a data é válida (> 0)
  if Assigned(dtultalteracaopreco) and (dtultalteracaopreco.Date > 0) then
  begin
    DataUltimaAlteracao := dtultalteracaopreco.Date;
  end
  else
  begin
    // Caso a data seja inválida (nunca alterado), exibe N/D
    if Assigned(editdiasnaoalterapreco) then
      editdiasnaoalterapreco.Text := 'N/D';
    Exit;
  end;

  // 2. Coleta a Data Atual (Apenas a data, sem a hora)
  DataAtual := Date;

  // 3. Calcula a Diferença em Dias
  // A diferença entre duas TDateTime é dada em dias (Extended).
  // Usamos Trunc para pegar apenas a parte inteira (o número de dias completos).
  DiasDiferenca := Trunc(DataAtual - DataUltimaAlteracao);

  // 4. Exibe o resultado no TEdit
  if Assigned(editdiasnaoalterapreco) then
  begin
    // Usa FormatFloat para garantir que o número seja exibido corretamente
    editdiasnaoalterapreco.Text := FormatFloat('0', DiasDiferenca);
  end;
end;




procedure TFormalterapreco.btnatualizaprecosClick(Sender: TObject);
begin
AplicarAjusteDePrecosEmMassa;
end;

procedure TFormalterapreco.CarregarUltimoUsuarioAlteracao;
var
  sCodInterno: string;
  sNomeUsuario: string;
begin
  // 1. Pega o código interno do produto (deve ser o mesmo que você preenche na DBLClick)
  if not Assigned(Editcodinterno) or (Trim(Editcodinterno.Text) = '') then
  begin
    editusuariomudoupreco.Text := 'N/D';
    Exit;
  end;
  sCodInterno := Trim(Editcodinterno.Text);

  // 2. Prepara e executa a consulta
  try
    // Usamos QRYUPDATE como query auxiliar temporária do DataModule1
    with DataModule1.QRYUPDATE do
    begin
      Close;

      SQL.Clear;
      SQL.Add('SELECT TOP 1');
      SQL.Add('    T2.USUARIO');
      SQL.Add('FROM');
      SQL.Add('    TabEst1Mov T1 WITH (NOLOCK)');
      SQL.Add('INNER JOIN');
      SQL.Add('    SERV T2 ON T2.Controle = T1.LkUsuario');
      SQL.Add('WHERE');
      SQL.Add('    T1.CodInterno = :CodInterno');

      // RECOMENDADO: Adicionar filtro de Tipo de Movimento (LkTipo)
      // se houver um tipo específico para 'Alteração de Preço' (Ex: LkTipo = 5)
      // Se não souber o LkTipo, esta query pega o último movimento de qualquer tipo.

      SQL.Add('ORDER BY');
      SQL.Add('    T1.Data DESC, T1.Hora DESC');

      ParamByName('CodInterno').AsString := sCodInterno;

      Open;

      // 3. Exibe o resultado
      if not IsEmpty then
      begin
        sNomeUsuario := FieldByName('USUARIO').AsString;

        // Exibe o nome do usuário no Edit
        if Assigned(editusuariomudoupreco) then
          editusuariomudoupreco.Text := sNomeUsuario;
      end
      else
      begin
        if Assigned(editusuariomudoupreco) then
          editusuariomudoupreco.Text := 'Não Encontrado';
      end;
      Close;
    end;
  except
    on E: Exception do
    begin
      // Em caso de erro na consulta
      if Assigned(editusuariomudoupreco) then
        editusuariomudoupreco.Text := 'Erro: ' + E.Message;
    end;
  end;
end;




procedure TFormalterapreco.CarregarListaBaseProdutos;
var
  SQLText: TStringList;
  sTermoBusca: string;
  iLkGrupoExcluir: Integer;
  iLkFornecedorExcluir: Integer;
  sMarcaExcluir: string;

  // Variáveis para a busca inteligente por palavras
  sPalavras: TStringList;
  sPalavra: string;
  sClausulaBuscaProduto: string;
  i: Integer;
begin
  // 1. Validação dos componentes
  if not Assigned(datamodule1.QRYPRODUTOSBASE) or not Assigned(datamodule1.DSQRYPRODUTOSBASE) or not Assigned(DBGRIDPRODUTOSBASE) then
  begin
    ShowMessage('Erro: Componentes de acesso a dados ou grid não foram criados.');
    Exit;
  end;

  // Coleta e preparação do termo de busca
  sTermoBusca := Trim(EDITCONSULTA.Text);

  // Quebra o termo de busca em palavras individuais (ex: 'kit relacoes' -> 'kit', 'relacoes')
  sPalavras := TStringList.Create;
  if sTermoBusca <> '' then
  begin
      sPalavras.CommaText := StringReplace(sTermoBusca, ' ', ',', [rfReplaceAll]);
  end;

  // 2. Coleta dos parâmetros de EXCLUSÃO (código omitido para brevidade, mas está completo na sua unit)

  iLkGrupoExcluir := 0;
  if (cmbgruponaoconsulta.ItemIndex > 0) and (cmbgruponaoconsulta.Items.Objects[cmbgruponaoconsulta.ItemIndex] <> nil) then
    iLkGrupoExcluir := Integer(cmbgruponaoconsulta.Items.Objects[cmbgruponaoconsulta.ItemIndex]);

  iLkFornecedorExcluir := 0;
  if (cmbfornecedornaoconsulta.ItemIndex > 0) and (cmbfornecedornaoconsulta.Items.Objects[cmbfornecedornaoconsulta.ItemIndex] <> nil) then
    iLkFornecedorExcluir := Integer(cmbfornecedornaoconsulta.Items.Objects[cmbfornecedornaoconsulta.ItemIndex]);

  sMarcaExcluir := '';
  if (cmbmarcanaoconsulta.ItemIndex > 0) and (cmbmarcanaoconsulta.Items[cmbmarcanaoconsulta.ItemIndex] <> 'Todos') then
    sMarcaExcluir := cmbmarcanaoconsulta.Items[cmbmarcanaoconsulta.ItemIndex];


  SQLText := TStringList.Create;
  try
    // 3. MONTAGEM DA QUERY SELECT
    SQLText.Add('SELECT');
    SQLText.Add('  P.Controle AS LkProduto,');
    SQLText.Add('  P.CodInterno,');
    SQLText.Add('  P.Produto,');

    // CAMPOS DE PREÇO/MARGEM
    SQLText.Add('  P.PrecoCusto, P.Lucro AS MargemVarejo, P.PrecoVenda AS PrecoVarejo,');
    SQLText.Add('  P.PerPrazo, P.PrPrazo, P.PerAtacado, P.PrAtacado, P.PerMinimo, P.PrMinimo,');
    SQLText.Add('  P.PrAtacado1, P.PrAtacado2, P.PrAtacado3, P.PrAtacado4,');
    SQLText.Add('  P.PerAtacado1, P.PerAtacado2, P.PerAtacado3, P.PerAtacado4,');
    SQLText.Add('  P.PrAtacado1Un, P.PrAtacado2Un, P.PrAtacado3Un, P.PrAtacado4Un,');
    // CAMPOS DE DETALHE E AUDITORIA (AGORA DIVIDIDOS)
    SQLText.Add('  P.Data, P.CodBarra, P.CodFornecedor, P.CodORIGEM, P.LkSetor, P.Fabricante,');
    SQLText.Add('  P.LkFornec, P.Moeda, P.QtdAtacado, P.QtdMinPrAtacado, P.UltVenda, P.DtAlteracao,');
    SQLText.Add('  P.UltReaj, P.LkUsuario, P.UltDtPreco, P.EstMinimo, P.Quantidade, P.QtdDepos,');
    SQLText.Add('  P.QtdFiscal, P.NaoSaiTabela');

    SQLText.Add('FROM tabest1 P WITH (NOLOCK)');

    // Filtros base de Inatividade
    SQLText.Add('WHERE P.Inativo <> 1');
    SQLText.Add('  AND P.NaoSaiTabela = 0');

    // 4. LÓGICA DE BUSCA TEXTUAL MELHORADA (Busca Inteligente)
    if sTermoBusca <> '' then
    begin
        // a. Monta a cláusula AND para o campo PRODUTO (lógica de "todos os termos")
        sClausulaBuscaProduto := '';
        for i := 0 to sPalavras.Count - 1 do
        begin
            sPalavra := Trim(sPalavras[i]);
            if sPalavra <> '' then
            begin
                // Acumula cada palavra com AND (Busca por 'kit' E 'relacoes')
                sClausulaBuscaProduto := sClausulaBuscaProduto + ' AND P.Produto LIKE ' + QuotedStr('%' + sPalavra + '%');
            end;
        end;

        // b. Aplica o filtro de busca inteligente + OR (busca completa) nos campos de código
        if Length(sClausulaBuscaProduto) > 5 then
        begin
            // Remove o primeiro ' AND ' da string
            sClausulaBuscaProduto := Copy(sClausulaBuscaProduto, 6, Length(sClausulaBuscaProduto));

            SQLText.Add('  AND (');
            // Busca Inteligente no PRODUTO
            SQLText.Add('      (' + sClausulaBuscaProduto + ')');

            // OU busca o termo completo nos outros campos de código (mantendo a flexibilidade)
            SQLText.Add('    OR P.CodInterno LIKE :BuscaCompleta');
            SQLText.Add('    OR P.CodFornecedor LIKE :BuscaCompleta');
            SQLText.Add('    OR P.CodBarra LIKE :BuscaCompleta');
            SQLText.Add('  )');
        end;
    end
    else
    begin
        // 5. APLICAÇÃO DOS FILTROS DE INCLUSÃO (Se não houver termo de busca)
        if cmbgrupo.ItemIndex > 0 then
          SQLText.Add('  AND P.LkSetor = :Grupo');

        if cmbfornecedor.ItemIndex > 0 then
          SQLText.Add('  AND P.LkFornec = :Fornecedor');

        if cmbmarca.ItemIndex > 0 then
          SQLText.Add('  AND P.Fabricante = :Marca');
    end;

    // 6. APLICAÇÃO DOS FILTROS DE EXCLUSÃO (Sempre aplicados)
    if iLkGrupoExcluir > 0 then
      SQLText.Add('  AND P.LkSetor <> :GrupoExcluir');

    if iLkFornecedorExcluir > 0 then
      SQLText.Add('  AND P.LkFornec <> :FornecedorExcluir');

    if sMarcaExcluir <> '' then
      SQLText.Add('  AND P.Fabricante <> :MarcaExcluir');

    SQLText.Add('ORDER BY P.Produto ASC');

    // 7. EXECUÇÃO E ATRIBUIÇÃO DE PARÂMETROS
    datamodule1.QRYPRODUTOSBASE.Close;
    datamodule1.QRYPRODUTOSBASE.Params.Clear;
    datamodule1.QRYPRODUTOSBASE.SQL.Text := SQLText.Text;
    datamodule1.QRYPRODUTOSBASE.Connection := DataModule1.ConDados;

    // Parâmetros
    if sTermoBusca <> '' then
      // O parâmetro 'BuscaCompleta' é usado apenas na busca por códigos
      datamodule1.QRYPRODUTOSBASE.ParamByName('BuscaCompleta').AsString := '%' + sTermoBusca + '%'
    else
    begin
      // Parâmetros de INCLUSÃO (se não houver busca textual)
      if cmbgrupo.ItemIndex > 0 then
        datamodule1.QRYPRODUTOSBASE.ParamByName('Grupo').AsInteger := Integer(cmbgrupo.Items.Objects[cmbgrupo.ItemIndex]);

      if cmbfornecedor.ItemIndex > 0 then
        datamodule1.QRYPRODUTOSBASE.ParamByName('Fornecedor').AsInteger := Integer(cmbfornecedor.Items.Objects[cmbfornecedor.ItemIndex]);

      if cmbmarca.ItemIndex > 0 then
        datamodule1.QRYPRODUTOSBASE.ParamByName('Marca').AsString := cmbmarca.Items[cmbmarca.ItemIndex];
    end;

    // Parâmetros de EXCLUSÃO
    if iLkGrupoExcluir > 0 then
      datamodule1.QRYPRODUTOSBASE.ParamByName('GrupoExcluir').AsInteger := iLkGrupoExcluir;

    if iLkFornecedorExcluir > 0 then
      datamodule1.QRYPRODUTOSBASE.ParamByName('FornecedorExcluir').AsInteger := iLkFornecedorExcluir;

    if sMarcaExcluir <> '' then
      datamodule1.QRYPRODUTOSBASE.ParamByName('MarcaExcluir').AsString := sMarcaExcluir;

    try
      datamodule1.QRYPRODUTOSBASE.Open;
      datamodule1.DSQRYPRODUTOSBASE.DataSet := datamodule1.QRYPRODUTOSBASE;
      DBGRIDPRODUTOSBASE.DataSource := datamodule1.DSQRYPRODUTOSBASE;

      // Carrega os detalhes do primeiro registro após a busca (Usando a lógica CodInterno)
      if not datamodule1.QRYPRODUTOSBASE.IsEmpty then
      begin
          CarregarDetalhesPorCodInterno(datamodule1.QRYPRODUTOSBASE.FieldByName('CODINTERNO').AsString);
      end;

      ContarRegistrosGrid;

    except
      on E: Exception do
        ShowMessage('Erro ao carregar lista base de produtos: ' + E.Message);
    end;
  finally
    SQLText.Free;
    sPalavras.Free;
  end;
end;












procedure TFormalterapreco.ContarRegistrosGrid;
var
  iContagem: Integer;
begin
  // 1. Garante que a query existe e está aberta
  if Assigned(datamodule1.QRYPRODUTOSBASE) and datamodule1.QRYPRODUTOSBASE.Active then
  begin
    // 2. Coleta a contagem de registros.
    iContagem := datamodule1.QRYPRODUTOSBASE.RecordCount;

    // 3. Exibe o resultado na LABELTOTAL, se ela estiver atribuída.
    if Assigned(LABELTOTAL) then
    begin
      // Exibe a mensagem formatada. Por exemplo: "Total: 150 produtos"
      LABELTOTAL.Caption := Format('Total de Registros: %d', [iContagem]);
    end
    else
    begin
      // Mensagem de fallback, caso a label não exista no DFM
      ShowMessage(Format('Total de registros encontrados na lista: %d', [iContagem]));
    end;
  end
  else
  begin
    // Limpa a label se a lista não estiver aberta ou se não houver registros
    if Assigned(LABELTOTAL) then
      LABELTOTAL.Caption := 'Total de Registros: 0';
  end;
end;




procedure TFormalterapreco.CarregarDetalhesPorCodInterno(const sCodInterno: string);
var
  QRY_DETALHE: TUniQuery;
  fEstoqueTotal: Extended;
  dDtUltPreco: TDateTime;
begin
  if Trim(sCodInterno) = '' then
    Exit;

  // 1. Configurar e Executar a Query de Detalhe
  QRY_DETALHE := DataModule1.QRYPRODUTOSDETALHES;

  with QRY_DETALHE do
  begin
    Close;

    // Você deve definir o SQL para buscar todos os campos da TABEST1
    // SELECT * FROM TABEST1 WHERE CodInterno = :CodInt
    SQL.Text := 'SELECT * FROM TABEST1 WHERE CodInterno = :CodInt';

    // Opcional: Se a QRYPRODUTOSDETALHES já tem o SQL definido, use apenas o filtro:
    // SQL.Text := 'SELECT * FROM TABEST1 WHERE CodInterno = :CodInt';

    ParamByName('CodInt').AsString := sCodInterno;
    Open;
  end;

  if QRY_DETALHE.IsEmpty then
  begin
    ShowMessage('Produto com Código Interno "' + sCodInterno + '" não encontrado.');
    Exit;
  end;

  // 2. CARREGAMENTO DOS CAMPOS NO FORMULÁRIO
  with QRY_DETALHE do
  begin
    // DADOS BÁSICOS E IDENTIFICAÇÃO (Removido NAOSAITABELA)
    labelproduto.caption       := FieldByName('PRODUTO').AsString;
    Editcodinterno.Text        := FieldByName('CODINTERNO').AsString;
    Editcodbarra.Text          := FieldByName('CODBARRA').AsString;
    Editcodfornecedor.Text     := FieldByName('CODFORNECEDOR').AsString;
    Editcodorigem.Text         := FieldByName('CODORIGEM').AsString;

    Editgrupo.Text             := FieldByName('lksetor').AsString;
    Editmarca.Text             := FieldByName('fabricante').AsString;
    Editfornecedor.Text        := FieldByName('lkfornec').AsString;
    Editlocalizacao.Text       := FieldByName('moeda').AsString; // Usando MOEDA como Localização

    // ESTOQUES (Carrega todos os estoques completos da TABEST1)
    DBTexestoqueloja.caption   := FormatFloat('0.00', FieldByName('quantidade').AsFloat);
    DBTextestoquedeposito.caption := FormatFloat('0.00', FieldByName('qtddepos').AsFloat);
    DBTextestoquefiscal.caption   := FormatFloat('0.00', FieldByName('qtdfiscal').AsFloat);
    DBTextestoqueminino.caption   := FormatFloat('0.00', FieldByName('estminimo').AsFloat);

    fEstoqueTotal := FieldByName('quantidade').AsFloat + FieldByName('qtddepos').AsFloat;
    DBTextestoquetotal.Caption    := FormatFloat('0.00', fEstoqueTotal);

    // Qtds Atacado
    editqtdembalagem.text      := FieldByName('qtdatacado').Asstring;
    editqtdminatacado.text     := FieldByName('qtdminpratacado').Asstring;

    // PREÇOS E MARGENS
    Editprcusto.Value          := FieldByName('PrecoCusto').AsCurrency;
    Editprcustomedio.Value     := FieldByName('CustoMedio').AsCurrency;

    // Margens Varejo (1 a 4)
    editmargemvarejo1.Value    := FieldByName('Lucro').AsFloat;
    editmargemvarejo2.Value    := FieldByName('perprazo').AsFloat;
    editmargemvarejo3.Value    := FieldByName('peratacado').AsFloat;
    editmargemvarejo4.Value    := FieldByName('perminimo').AsFloat;

    // Preços Varejo (1 a 4)
    editprecovarejo1.Value     := FieldByName('precovenda').AsFloat;
    editprecovarejo2.Value     := FieldByName('prprazo').AsFloat;
    editprecovarejo3.Value     := FieldByName('pratacado').AsFloat;
    editprecovarejo4.Value     := FieldByName('prminimo').AsFloat;

    // Margens Atacado (1 a 4)
    editmargematacado1.Value   := FieldByName('peratacado1').AsFloat;
    editmargematacado2.Value   := FieldByName('peratacado2').AsFloat;
    editmargematacado3.Value   := FieldByName('peratacado3').AsFloat;
    editmargematacado4.Value   := FieldByName('peratacado4').AsFloat;

    // Preços Atacado (1 a 4)
    editprecoatacado1.Value    := FieldByName('pratacado1').AsFloat;
    editprecoatacado2.Value    := FieldByName('pratacado2').AsFloat;
    editprecoatacado3.Value    := FieldByName('pratacado3').AsFloat;
    editprecoatacado4.Value    := FieldByName('pratacado4').AsFloat;

    // Preços Atacado Unitário (1 a 4)
    editprecounatacado1.Value  := FieldByName('pratacado1').AsFloat;
    editprecounatacado2.Value  := FieldByName('pratacado2').AsFloat;
    editprecounatacado3.Value  := FieldByName('pratacado3').AsFloat;
    editprecounatacado4.Value  := FieldByName('pratacado4').AsFloat;

    // DATAS E USUÁRIOS
    dtdatacastro.Date          := FieldByName('Data').AsDateTime;
    dtultvenda.Date            := FieldByName('ultvenda').AsDateTime;
    dtultalteracao.Date        := FieldByName('DtAlteracao').AsDateTime;
    dtultcompra.Date           := FieldByName('ultreaj').AsDateTime;
    Editultalterar.Text        := FieldByName('lkusuario').Asstring;

    // Data da Última Alteração de Preço
    dDtUltPreco := 0;
    if (FindField('UltDtPreco') <> nil) then
      dDtUltPreco := FieldByName('UltDtPreco').AsDateTime;
    dtultalteracaopreco.Date := dDtUltPreco;

    // 3. CHAMADAS DE AUDITORIA
    AtualizarDiasSemAlteracao; // Utiliza a data de dtultalteracaopreco
    CarregarUltimoUsuarioAlteracao; // Utiliza Editcodinterno.Text

  end;
END;


END.
