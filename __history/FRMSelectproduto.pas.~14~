unit FRMSelectproduto;

interface

uses
  Winapi.Windows, Winapi.Messages, System.SysUtils, System.Variants, System.Classes, Vcl.Graphics,
  Vcl.Controls, Vcl.Forms, Vcl.Dialogs, Data.DB, Vcl.Grids, Vcl.DBGrids,
  Vcl.StdCtrls, Vcl.ExtCtrls;

type
  TSelectProduto = class(TForm)
    Panel1: TPanel;
    Editselectproduto: TEdit;
    Label1: TLabel;
    DBGridprodutos: TDBGrid;
    Label2: TLabel;
    procedure LimparFormulario;
    procedure EditselectprodutoChange(Sender: TObject);
    procedure DBGridprodutosDblClick(Sender: TObject);
    procedure DBGridprodutosKeyPress(Sender: TObject; var Key: Char);
    procedure EditselectprodutoKeyDown(Sender: TObject; var Key: Word;
      Shift: TShiftState);
    procedure FormShow(Sender: TObject);
  private
    { Private declarations }
  public
    { Public declarations }
  end;

var
  SelectProduto: TSelectProduto;

implementation

{$R *.dfm}

uses CONEXAOBD, FRMAGESTOQUE;


procedure TSelectProduto.LimparFormulario;
begin
  Editselectproduto.Text := ''; // Limpa o campo de pesquisa
  DBGridProdutos.DataSource := nil; // Remove a fonte de dados temporariamente
  DataModule1.QRYSELECIONAPRODUTOS.Close; // Fecha a query
  DataModule1.QRYSELECIONAPRODUTOS.SQL.Text := 'SELECT * FROM tabest1 WHERE 1=0'; // Query vazia
  DataModule1.QRYSELECIONAPRODUTOS.Open; // Reabre a query vazia
end;

procedure TSelectProduto.DBGridprodutosDblClick(Sender: TObject);
begin
  if not DataModule1.qrySelecionaProdutos.IsEmpty then
  begin

    frmmenu.labelproduto.caption := DataModule1.qrySelecionaProdutos.FieldByName('PRODUTO').AsString;

    if Assigned(frmmenu.Editcodinterno) then
      frmmenu.Editcodinterno.Text := DataModule1.qrySelecionaProdutos.FieldByName('CODINTERNO').AsString;

    if Assigned(frmmenu.Editcodbarra) then
      frmmenu.Editcodbarra.Text := DataModule1.qrySelecionaProdutos.FieldByName('CODBARRA').AsString;

    if Assigned(frmmenu.Editcodfornecedor) then
      frmmenu.Editcodfornecedor.Text := DataModule1.qrySelecionaProdutos.FieldByName('CODFORNECEDOR').AsString;

    if Assigned(frmmenu.Editcodorigem) then
      frmmenu.Editcodorigem.Text := DataModule1.qrySelecionaProdutos.FieldByName('CODorigem').AsString;

    if Assigned(frmmenu.Editgrupo) then
      frmmenu.Editgrupo.Text := DataModule1.qrySelecionaProdutos.FieldByName('lksetor').AsString;

    if Assigned(frmmenu.Editmarca) then
      frmmenu.Editmarca.Text := DataModule1.qrySelecionaProdutos.FieldByName('fabricante').AsString;

    if Assigned(frmmenu.Editfornecedor) then
      frmmenu.Editfornecedor.Text := DataModule1.qrySelecionaProdutos.FieldByName('lkfornec').AsString;

    if Assigned(frmmenu.Editlocalizacao) then
      frmmenu.Editlocalizacao.Text := DataModule1.qrySelecionaProdutos.FieldByName('moeda').AsString;


if Assigned(frmmenu.DBTexestoqueloja) then
    frmmenu.DBTexestoqueloja.caption := FormatFloat('0.00', DataModule1.qrySelecionaProdutos.FieldByName('quantidade').AsFloat);

if Assigned(frmmenu.DBTextestoquedeposito) then
    frmmenu.DBTextestoquedeposito.caption := FormatFloat('0.00', DataModule1.qrySelecionaProdutos.FieldByName('qtddepos').AsFloat);

if Assigned(frmmenu.DBTextestoquefiscal) then
    frmmenu.DBTextestoquefiscal.caption := FormatFloat('0.00', DataModule1.qrySelecionaProdutos.FieldByName('qtdfiscal').AsFloat);

if Assigned(frmmenu.DBTextestoqueminino) then
    frmmenu.DBTextestoqueminino.caption := FormatFloat('0.00', DataModule1.qrySelecionaProdutos.FieldByName('estminimo').AsFloat);

frmmenu.DBTextestoquetotal.Caption := FormatFloat('0.00', DataModule1.qrySelecionaProdutos.FieldByName('quantidade').AsFloat + DataModule1.qrySelecionaProdutos.FieldByName('qtddepos').AsFloat);


 // INFORMAÇAO DE PREÇOS


if Assigned(frmmenu.Editprcusto) then
frmmenu.Editprcusto.Value := DataModule1.qrySelecionaProdutos.FieldByName('PrecoCusto').AsCurrency;


if Assigned(frmmenu.Editprcustomedio) then
frmmenu.Editprcustomedio.Value := DataModule1.qrySelecionaProdutos.FieldByName('CustoMedio').AsCurrency;


// Margem de Lucro Varejo (Campo 'Lucro')
if Assigned(frmmenu.editmargemvarejo1) then
    frmmenu.editmargemvarejo1.Value := DataModule1.qrySelecionaProdutos.FieldByName('Lucro').AsFloat;







    Close;

  end;
end;

procedure TSelectProduto.DBGridprodutosKeyPress(Sender: TObject; var Key: Char);
begin
  if Key = #13 then // Código para tecla Enter
  begin
    DBGridProdutosDblClick(Sender); // Chama o evento de duplo clique
    Close; // Fecha o formulário de seleção
  end;
end;


procedure TSelectProduto.EditSelectProdutoChange(Sender: TObject);
begin
  with DataModule1.qrySelecionaProdutos do
  begin
    Close;
    SQL.Text := 'SELECT * FROM TABEST1 ' +
                'WHERE CODIGO LIKE ' + QuotedStr('%' + EditSelectProduto.Text + '%') +
                ' OR CODINTERNO LIKE ' + QuotedStr('%' + EditSelectProduto.Text + '%') +
                ' OR CODBARRA LIKE ' + QuotedStr('%' + EditSelectProduto.Text + '%') +
                ' OR CODFORNECEDOR LIKE ' + QuotedStr('%' + EditSelectProduto.Text + '%') +
                ' OR PRODUTO LIKE ' + QuotedStr('%' + EditSelectProduto.Text + '%');
    Open;
  end;

  // Associa a query ao DBGrid
  DBGridProdutos.DataSource := DataModule1.DSQRYSELECIONAPRODUTO;
end;

procedure TSelectProduto.EditselectprodutoKeyDown(Sender: TObject;
  var Key: Word; Shift: TShiftState);
begin
  if Key = VK_DOWN then // Tecla para baixo
  begin
    DBGridProdutos.SetFocus; // Move o foco para o DBGrid
    SendMessage(DBGridProdutos.Handle, WM_KEYDOWN, VK_DOWN, 0); // Simula a tecla para baixo
  end
  else if Key = VK_UP then // Tecla para cima
  begin
    DBGridProdutos.SetFocus; // Move o foco para o DBGrid
    SendMessage(DBGridProdutos.Handle, WM_KEYDOWN, VK_UP, 0); // Simula a tecla para cima
  end;
end;

procedure TSelectProduto.FormShow(Sender: TObject);
begin
EditSelectProduto.SetFocus;
end;

end.
