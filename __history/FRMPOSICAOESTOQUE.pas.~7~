unit FRMPOSICAOESTOQUE;

interface

uses
  Winapi.Windows, Winapi.Messages, System.SysUtils, System.Variants, System.Classes, Vcl.Graphics,
  Vcl.Controls, Vcl.Forms, Vcl.Dialogs, Vcl.ExtCtrls, Data.DB, Vcl.Grids,
  Vcl.DBGrids, Vcl.StdCtrls, MemDS, DBAccess, Uni;

type
  TFormposicaoest = class(TForm)
    Panel1: TPanel;
    Panel2: TPanel;
    Label1: TLabel;
    DBGridprodutos: TDBGrid;
    Label2: TLabel;
    DBGridpedidos: TDBGrid;
    QRYPRODUTOSABERTOS: TUniQuery;
    DSQRYPRODUTOSABERTOS: TDataSource;
    procedure CarregarPosicaoEExibir;
    procedure QRYPRODUTOSABERTOSAfterClose(DataSet: TDataSet);
  private
    { Private declarations }
  public
    { Public declarations }
  end;

var
  Formposicaoest: TFormposicaoest;

implementation

{$R *.dfm}

uses CONEXAOBD, FRMAGESTOQUE, FRMMOVIMENTO, FRMSelectproduto, FRMSENHA;



procedure TFormposicaoest.CarregarPosicaoEExibir;
var
  sCodInterno: string;
  dDataInicio, dDataFim: TDateTime;
  iLkProduto: Integer;
begin
  // 1. COLETA DOS PARÂMETROS DO FRMMENU
  if not Assigned(frmmenu) then
  begin
    ShowMessage('Erro: Formulário principal não inicializado.');
    Exit;
  end;

  sCodInterno := Trim(frmmenu.Editcodinterno.Text);
  dDataInicio := frmmenu.dtinicio.Date; // Assume dtinicio existe no frmmenu
  dDataFim := frmmenu.dtfim.Date;       // Assume dtfim existe no frmmenu

  if sCodInterno = '' then
  begin
    ShowMessage('Nenhum produto selecionado (Código Interno está vazio).');
    Exit;
  end;

  // 2. BUSCA O LKPRODUTO (Controle) DO PRODUTO ATUAL NA TABEST1
  // QRYSEQ é usada para consultas rápidas no DataModule1
  with DataModule1.QRYSEQ do
  begin
    Close;
    SQL.Text := 'SELECT Controle FROM TABEST1 WITH (NOLOCK) WHERE CodInterno = :CodInterno';
    ParamByName('CodInterno').AsString := sCodInterno;
    Open;

    if IsEmpty then
    begin
      ShowMessage('Produto não encontrado na base TABEST1.');
      Close;
      Exit;
    end;
    iLkProduto := FieldByName('Controle').AsInteger;
    Close;
  end;


  // 3. EXECUÇÃO DA CONSULTA MESTRA (QRYPRODUTOSABERTOS)
  // Carrega apenas o produto selecionado na QRYPRODUTOSABERTOS
  with QRYPRODUTOSABERTOS do
  begin
    Close;
    // Note: Replicamos a SQL do frmmenu, mas sem os filtros de data no cabeçalho,
    // pois a consulta mestra original já era complexa.
    SQL.Text :=
        'SELECT ' +
        '    B.LkProduto AS LkProduto, P.CodInterno, P.Produto, P.CodBarra, P.Moeda AS Localizacao, ' +
        '    G.Setor AS Grupo, P.Fabricante AS Marca, F.Empresa AS Fornecedor, P.Quantidade AS QtdEstoque, ' +
        '    CAST(SUM(B.Qtdreal) AS NUMERIC(12, 2)) AS QtdReserva, COUNT(DISTINCT A.Pedido) AS NumPedidos ' +
        'FROM TabEst3B B WITH (NOLOCK) ' +
        'INNER JOIN TabEst3A A WITH (NOLOCK) ON A.Pedido = B.PEDIDO ' +
        'INNER JOIN TABEST1 P WITH (NOLOCK) ON P.Controle = B.LkProduto ' +
        'LEFT JOIN TabEst8 G WITH (NOLOCK) ON P.LkSetor = G.Controle ' +
        'LEFT JOIN TabFor F WITH (NOLOCK) ON P.LkFornec = F.Controle ' +
        'WHERE A.Cancelada <> 1 AND A.VENDA <> 1 AND A.STATUS IN (''P'') ' +
        '  AND P.Controle = :LkProduto ' + // Filtro Mestre/Detalhe: Apenas o produto ativo
        'GROUP BY B.LkProduto, P.CodInterno, P.Produto, P.Quantidade, P.CodFornecedor, P.Moeda, G.Setor, P.Fabricante, F.Empresa, P.CodBarra ' +
        'ORDER BY P.Produto';

    ParamByName('LkProduto').AsInteger := iLkProduto;
    Open;
  end;

  // 4. EXECUÇÃO DA CONSULTA DETALHE (QRYPEDIDOS)
  // Carrega os pedidos abertos para o produto (reutilizando a lógica do frmmenu)
  with DataModule1.QRYPEDIDOS do
  begin
    Close;
    SQL.Text :=
      'SELECT A.*, B.Qtdreal AS QuantidadeItem, ' +
      ' CASE WHEN A.STATUS = ''P'' THEN ''PRÉ-VENDA'' ELSE ''OUTROS'' END AS Situacao ' +
      'FROM TabEst3A A WITH (NOLOCK) ' +
      'INNER JOIN TabEst3B B WITH (NOLOCK) ON A.Pedido = B.PEDIDO ' +
      'WHERE A.Data >= :DataInicio AND A.Data <= :DataFim ' +
      '  AND A.Cancelada <> 1 AND A.VENDA <> 1 AND A.STATUS =''P'' ' +
      '  AND B.LkProduto = :LkProduto ' +
      'ORDER BY A.Pedido DESC';

    ParamByName('DataInicio').AsDateTime := dDataInicio;
    ParamByName('DataFim').AsDateTime := dDataFim;
    ParamByName('LkProduto').AsInteger := iLkProduto;
    Open;
  end;


  // 5. LIGAÇÃO DOS GRIDS E EXIBIÇÃO
  DBGridprodutos.DataSource := DSQRYPRODUTOSABERTOS;
  DBGridpedidos.DataSource := DataModule1.DSQRYPEDIDOS;

  Label1.Caption := 'Produtos com Reserva/Pré-Venda (Cód: ' + sCodInterno + ')';
  Label2.Caption := 'Pedidos de Reserva Detalhados:';

  Self.ShowModal;
end;

procedure TFormposicaoest.QRYPRODUTOSABERTOSAfterClose(DataSet: TDataSet);

begin
  // Esta procedure garante que, se a Query Mestra fechar (por filtro, limpeza, etc.),
  // a Query Detalhe seja forçada a fechar, limpando o DBCtrlGridpedidos.
  if datamodule1.QRYPEDIDOS.Active then
    datamodule1.QRYPEDIDOS.Close;
end;

end.
