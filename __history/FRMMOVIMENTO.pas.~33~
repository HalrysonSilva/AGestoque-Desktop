unit FRMMOVIMENTO;

interface

uses
  Winapi.Windows, Winapi.Messages, System.SysUtils, System.Variants, System.Classes, Vcl.Graphics,
  Vcl.Controls, Vcl.Forms, Vcl.Dialogs, Data.DB, Vcl.Grids, Vcl.DBGrids,
  Vcl.ExtCtrls, Vcl.StdCtrls;

type
  Tformmov = class(TForm)
    Panel2: TPanel;
    DBGridmovestoque: TDBGrid;
    Labelprod: TLabel;
    procedure CarregaMovProdutosContados;
    procedure CarregaMovalterapreco;


  private
    { Private declarations }
  public
    { Public declarations }
  end;

var
  formmov: Tformmov;

implementation

{$R *.dfm}

uses CONEXAOBD, FRMCONTARESTOQUE, FRMSelectproduto, FRMSENHA, FRM_MENU,
  FRMALTERAPRECOS, FRMPOSICAOESTOQUE;


procedure Tformmov.CarregaMovProdutosContados;
var
  sCodInterno: string;
begin
  if not Assigned(formcontaestoque) or not Assigned(formcontaestoque.DBText45) or
     (Trim(formcontaestoque.DBText45.Caption) = '') then
  begin
    ShowMessage('O Código Interno do produto não está disponível no formulário principal.');
    Exit;
  end;

  sCodInterno := Trim(formcontaestoque.DBText45.Caption);

  if Assigned(formcontaestoque.DBText14) then
    LabelProd.Caption := formcontaestoque.DBText14.Caption
  else
    LabelProd.Caption := 'Produto não carregado';

  if not Assigned(DBGridmovestoque.DataSource) then
    DBGridmovestoque.DataSource := DataModule1.DSqryTabest1mov;

  try
    with DataModule1.qryTabest1mov do
    begin
      Close;
      SQL.Clear;

      SQL.Add('SELECT TOP 50');
      SQL.Add('    M.PrecoCustoAnterior,');
      SQL.Add('    M.PrecoCustoNovo,');
      SQL.Add('    M.PrecoVendaAnterior,');
      SQL.Add('    M.PrecoVendaNovo,');
      SQL.Add('    M.MargemVarejoAnterior,');
      SQL.Add('    M.MargemVarejoNova,');
      SQL.Add('    M.PerAtacado4Novo,');
      SQL.Add('    M.Interior,');
      SQL.Add('    T.Tipo,');
      SQL.Add('    U.USUARIO AS NomeUsuario,');
      SQL.Add('    CASE M.LkOperacao WHEN 1 THEN ''SAIDA'' ELSE ''ENTRADA'' END AS OperacaoEstoque,');
      SQL.Add('    M.*'); // restante dos campos da tabela

      SQL.Add('FROM TabEst1Mov M WITH (NOLOCK)');
      SQL.Add('INNER JOIN SERV U ON U.Controle = M.LkUsuario');
      SQL.Add('INNER JOIN TabEstMovTipo T ON T.Controle = M.LkTipo');
      SQL.Add('WHERE M.CodInterno = :CodInterno');
      SQL.Add('ORDER BY M.Data DESC');

      ParamByName('CodInterno').AsString := sCodInterno;
      Open;
    end;

    DBGridmovestoque.Refresh;
    Self.ShowModal;

  except
    on E: Exception do
      ShowMessage('Erro ao consultar movimentação: ' + E.Message);
  end;
end;






procedure Tformmov.CarregaMovalterapreco;
var
  sCodInterno: string;
begin
  // 1. Validação e Captura do CodInterno
  if not Assigned(Formalterapreco) or not Assigned(Formalterapreco.Editcodinterno) or (Trim(Formalterapreco.Editcodinterno.text) = '') then
  begin
    ShowMessage('O Código Interno do produto não está disponível no formulário principal.');
    Exit;
  end;

  sCodInterno := Trim(Formalterapreco.Editcodinterno.text);

  // 1.5. CAPTURA O NOME DO PRODUTO
  if Assigned(Formalterapreco.labelproduto) and (Formalterapreco.labelproduto.Caption <> '') then
    LabelProd.Caption := Formalterapreco.labelproduto.Caption
  else
    LabelProd.Caption := 'Produto não carregado';

  // Verifica se o DBGrid tem o DataSource antes de tentar abrir
  if not Assigned(DBGridmovestoque.DataSource) then
  begin
    DBGridmovestoque.DataSource := DataModule1.DSqryTabest1mov;
  end;

    try
    with DataModule1.qryTabest1mov do
    begin
      Close;
      SQL.Clear;

      SQL.Add('SELECT TOP 50');
      SQL.Add('    M.PrecoCustoAnterior,');
      SQL.Add('    M.PrecoCustoNovo,');
      SQL.Add('    M.PrecoVendaAnterior,');
      SQL.Add('    M.PrecoVendaNovo,');
      SQL.Add('    M.MargemVarejoAnterior,');
      SQL.Add('    M.MargemVarejoNova,');
      SQL.Add('    M.PerAtacado4Novo,');
      SQL.Add('    M.Interior,');
      SQL.Add('    T.Tipo,');
      SQL.Add('    U.USUARIO AS NomeUsuario,');
      SQL.Add('    CASE M.LkOperacao WHEN 1 THEN ''SAIDA'' ELSE ''ENTRADA'' END AS OperacaoEstoque,');
      SQL.Add('    M.*'); // restante dos campos da tabela

      SQL.Add('FROM TabEst1Mov M WITH (NOLOCK)');
      SQL.Add('INNER JOIN SERV U ON U.Controle = M.LkUsuario');
      SQL.Add('INNER JOIN TabEstMovTipo T ON T.Controle = M.LkTipo');
      SQL.Add('WHERE M.CodInterno = :CodInterno');
      SQL.Add('ORDER BY M.Data DESC');

      ParamByName('CodInterno').AsString := sCodInterno;
      Open;
    end;

    // 4. Exibe o formulário modalmente
    Self.ShowModal;

  except
    on E: Exception do
    begin
      ShowMessage('Erro ao consultar movimentação: ' + E.Message);
    end;
  end;
end;













end.
